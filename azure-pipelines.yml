pool:
  vmImage: 'vs2017-win2016'

variables:
  buildConfiguration: 'Release'

steps:
#- script: |
    #dotnet build ./src/ClassLibrary1/ClassLibrary1.csproj --configuration $(buildConfiguration)
    #dotnet build ./src/ClassLibrary2/ClassLibrary2.csproj --configuration $(buildConfiguration)
  #displayName: 'dotnet build $(buildConfiguration) Libraries'
  
 # Based on https://whereslou.com/2018/09/versioning-and-publishing-nuget-packages-automatically-using-azure-devops-pipelines/ 
- task: DotNetCoreCLI@2
  displayName: Build and Pack !
  inputs:
    command: 'build'
    arguments: /p:Configuration=$(BuildConfiguration) # https://github.com/MicrosoftDocs/vsts-docs/issues/1976
    projects: '**/*.csproj'
    packDirectory: '$(Build.ArtifactStagingDirectory)/packages'
    verbosityPack: 'normal'

#- task: DotNetCoreCLI@2
#  displayName: Pack !
#  inputs:
#    command: pack
#    projects: '**/*.csproj'
#    nobuild: true
#    packDirectory: '$(Build.ArtifactStagingDirectory)/packages'
#    versioningScheme: 'byPrereleaseNumber'
#    verbosityPack: 'detailed'

- task: PublishBuildArtifacts@1
  displayName: Publish Artifacts !
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'

- task: DotNetCoreCLI@2
  displayName: dotnet nuget push
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
  inputs:
    command: custom
    custom: nuget
    arguments: push $(Build.ArtifactStagingDirectory)\packages\*.nupkg --source https://www.myget.org/F/stef-test/api/v3/index.json --no-service-endpoint --api-key $(MyGetKey)

#- task: DotNetCoreCLI@2
#  displayName: 'MyGet !'
#  inputs:
#    configuration: 'Release'
#    command: 'push'
#    projects: '**/*.csproj'
#    packagesToPush: '**/*.nupkg'
#    nuGetFeedType: 'external' 
#    publishVstsFeed: 'https://www.myget.org/F/stef-test/api/v2/package'
#    publishFeedCredentials: '$(MyGetKey)'
#    versioningScheme: 'byPrereleaseNumber'